<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #kakao-map, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        /* ì¹´ì¹´ì˜¤ì§€ë„ë¥¼ ë°°ê²½ìœ¼ë¡œ ë‘ê³ , Leafletì€ ê·¸ ìœ„ì— ì˜¤ë²„ë ˆì´ë¡œ ì˜¬ë¦½ë‹ˆë‹¤. */
        #kakao-map, #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #kakao-map {
            z-index: 0;
        }
        #map {
            z-index: 1;
            background: transparent;
        }
        /* íŒì—…(ì†ì„±í‘œ) ê°€ë…ì„± ê°œì„  */
        .leaflet-popup-content table {
            border-collapse: collapse;
            width: 100%;
        }
        .leaflet-popup-content th,
        .leaflet-popup-content td {
            padding: 2px 6px;
            vertical-align: top;
            word-break: break-word;
            white-space: normal;
        }
        .leaflet-popup-content th {
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0.85;
        }
        /* íŒì—… í•„ë“œ í† ê¸€ ì»¨íŠ¸ë¡¤ UI */
        .popup-field-toggle {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            max-height: 45vh;
            overflow: auto;
            font: 12px/1.2 Arial, Helvetica, sans-serif;
        }
        .popup-field-toggle .title {
            font-weight: 700;
            margin-bottom: 6px;
        }
        .popup-field-toggle .actions {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .popup-field-toggle .actions button {
            font-size: 11px;
            padding: 2px 6px;
            cursor: pointer;
        }
        .popup-field-toggle label {
            display: flex;
            gap: 6px;
            align-items: center;
            margin: 3px 0;
            cursor: pointer;
            user-select: none;
        }
        /* ë¼ë²¨(íˆ´íŒ) í­/ì¤„ë°”ê¿ˆ ì œì–´ */
        .leaflet-tooltip.css_map_data {
            /* ê¸°ë³¸ leaflet max-width ë•Œë¬¸ì— ê¸€ìê°€ ì„¸ë¡œë¡œ êº¾ì´ëŠ” í˜„ìƒ ë°©ì§€ */
            max-width: none !important;
            width: max-content; /* ê°€ëŠ¥í•˜ë©´ ë‚´ìš©ë§Œí¼ ê°€ë¡œë¡œ í™•ì¥ */
            white-space: normal; /* ì‹¤ì œ ì¤„ë°”ê¿ˆì€ ë‚´ë¶€ .q2w-labelì´ ì œì–´ */

			color: #000000 !important;      /* ê¸€ììƒ‰ì„ ê²€ì •ìœ¼ë¡œ */
        	font-weight: bold;              /* (ì„ íƒ) ê¸€ìë¥¼ ë” ì§„í•˜ê²Œ í•˜ë ¤ë©´ ì¶”ê°€ */
    		text-shadow: 1px 1px 2px white; /* (ì„ íƒ) ê²€ì€ ê¸€ì”¨ê°€ ë” ì˜ ë³´ì´ê²Œ í°ìƒ‰ ì™¸ê³½ì„  ì¶”ê°€ */
        }
        .leaflet-tooltip.css_map_data .q2w-label {
			color : #000000 !important;
            display: inline-block;
            max-width: none !important;
        }
        .q2w-label.q2w-label--single {
            white-space: nowrap; /* 1ê°œ í•„ë“œì¼ ë•ŒëŠ” ê°€ë¡œë¡œ */
        }
        .q2w-label.q2w-label--multi {
            white-space: pre-line; /* 2ê°œ ì´ìƒì´ë©´ ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
        /* ë¼ë²¨(íˆ´íŒ) í† ê¸€ì„ ìœ„í•œ CSS */
        .labels-hidden .leaflet-tooltip-pane {
            display: none;
        }
		/* íŒì—… ê°€ë¡œ ë„“ì´ ë° ë””ìì¸ ìˆ˜ì • */
		.leaflet-popup-content-wrapper {
		    width: 450px !important;    /* ìƒì ì „ì²´ ë„ˆë¹„ (ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì •) */
		    border: 2px solid #0000ff;  /* ì•„ê¹Œ ì›í•˜ì…¨ë˜ íŒŒë€ í…Œë‘ë¦¬ ì¶”ê°€ */
		}
		
		.leaflet-popup-content {
		    width: 420px !important;    /* ì‹¤ì œ ë‚´ìš©ì´ ë“¤ì–´ê°€ëŠ” ë„ˆë¹„ (wrapperë³´ë‹¤ ì•½ê°„ ì‘ê²Œ) */
		}

				/* ê²€ìƒ‰ì°½ ì»¨í…Œì´ë„ˆ ë””ìì¸ */
		.search-filter-container {
		    position: absolute;
		    top: 15px;      /* ìœ„ì¹˜ ì¡°ì • */
		    left: 60px;     /* ì¤Œ ì»¨íŠ¸ë¡¤ ì˜† */
		    z-index: 1000;
		    display: flex;
		    gap: 5px;
		}
		
		.search-filter-input {
		    width: 200px;
		    padding: 8px 12px;
		    border: 2px solid #0051af;
		    border-radius: 20px;
		    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
		    outline: none;
		    font-size: 14px;
		}
		
		.search-filter-input:focus {
		    background-color: #f0f7ff;
		}
		
		/* íŒì—… í™”ë©´ ì¤‘ì•™ ê³ ì • */
		.custom-central-popup.leaflet-popup {
			z-index: 10000 !important; /* ê°€ë¦¼íŒ(1000)ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
		}
		
		
		/* íŒì—… ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
		.popup-image-container img {
		    width: 100%;
		    max-height: 300px;
		    object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê²Œ */
		    border-radius: 8px;
		    margin-bottom: 10px;
		}



			
        </style>
        <title></title>
    </head>
    <body>
        <div id="kakao-map"></div>
		<div id="map"></div>
				/* í†µí•© ìƒì„¸ í•„í„° íŒ¨ë„ */
		<div class="filter-panel" style="position: fixed; top: 20px; left: 70px; z-index: 2000; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 280px; font-family: sans-serif;">
		    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">ìƒì„¸ í•„í„°</h4>
		    
		    <div style="margin-bottom: 8px;">
		        <label style="font-size: 11px; color: #666;">ì œì¶œì²˜</label>
		        <input type="text" class="multi-filter-input" data-field="ì œì¶œì²˜" placeholder="ì˜ˆ: ê¸°ì—…ì€í–‰" style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
		    </div>
		    
		    <div style="margin-bottom: 8px;">
		        <label style="font-size: 11px; color: #666;">ì£¼ì†Œ</label>
		        <input type="text" class="multi-filter-input" data-field="ì£¼ì†Œ" placeholder="ì˜ˆ: ì„œìš¸" style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
		    </div>
		
		    <div style="margin-bottom: 8px;">
		        <label style="font-size: 11px; color: #666;">ë‹´ë‹¹ì</label>
		        <input type="text" class="multi-filter-input" data-field="ë‹´ë‹¹ì" placeholder="ë‹´ë‹¹ì ì´ë¦„" style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
		    </div>

			<div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 1px dashed #ccc;">
		        <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #555;">ì§€ë„ ë¶€ê°€ ê¸°ëŠ¥</div>
		        <label style="display: block; font-size: 12px; margin-bottom: 5px; cursor: pointer;">
		            <input type="checkbox" class="kakao-layer-toggle" data-type="USE_DISTRICT"> ğŸ—ºï¸ ì§€ì í¸ì§‘ë„
		        </label>
		        <label style="display: block; font-size: 12px; margin-bottom: 5px; cursor: pointer;">
		            <input type="checkbox" class="kakao-layer-toggle" data-type="TRAFFIC"> ğŸš¦ ì‹¤ì‹œê°„ êµí†µ
		        </label>
		        <label style="display: block; font-size: 12px; cursor: pointer;">
		            <input type="checkbox" class="kakao-layer-toggle" data-type="ROADVIEW"> ğŸ“· ë¡œë“œë·° ë„ë¡œ í™•ì¸
		        </label>
		    </div>
			<div style="margin-top: 10px; padding: 10px; background: #eef7ff; border-radius: 10px; border: 1px solid #abd4ff;">
			    <div style="font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #0051af;">ğŸ“‚ ì™¸ë¶€ GeoJSON ë¶ˆëŸ¬ì˜¤ê¸°</div>
			    <input type="file" id="external-geojson-input" accept=".json,.geojson" style="font-size: 11px; width: 100%;">
			</div>
		    <div id="filter-result-count" style="font-size: 12px; color: #0051af; font-weight: bold; margin-top: 10px; text-align: right;"></div>
			<button onclick="exportToExcel()" style="width: 100%; margin-top: 10px; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px;">
			    ğŸ“Š í˜„ì¬ ê²€ìƒ‰ê²°ê³¼ ì—‘ì…€ ì €ì¥
			</button>
		</div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=231190ac1aca72ada0b739110d8a0eb4"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/kakao_base.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/map_data.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[37.43966984122166,126.86818683641245],[37.6101521616503,127.1412179712234]]);
        // Kakao Roadmap(ì¼ë°˜ì§€ë„/Street) ë°°ê²½ì§€ë„ ì´ˆê¸°í™” + Leaflet ë·° ë™ê¸°í™”
        initKakaoBaseMap(map, { mapTypeId: 'ROADMAP' });
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // íŒì—…ì— í‘œì‹œí•  í•„ë“œ(ì†ì„±)ë³„ í† ê¸€ ì„¤ì •
        var popupFieldConfig_map_data = (function() {
            var fields = [
                'ê°ì •ì„œë²ˆí˜¸', 'ë³¸ì‚¬/ì§€ì‚¬', 'ë‹´ë‹¹ì', 'í‰ê°€ì‚¬', 'ê±´ëª…', 'ê±°ë˜ì²˜ëª…', 'ì˜ë¢°ì¸', 'ìƒíƒœ',
                'ì˜ë¢°ì¼ì', 'ë°œì†¡ì¼ì', 'ì†Œìœ ìì „í™”', 'ì±„ë¬´ì', 'ì±„ë¬´ìì „í™”', 'ì˜ë¢°ë¬¸ì„œë²ˆ', 'ì˜ë¢°ë¶€ì„œ',
                'ì œì¶œì²˜', 'ì œì¶œì²˜(Tar', 'ì œì¶œì²˜(T_1', 'ì œì¶œì²˜(T_2', 'ì†Œìœ ì', 'í‰ê°€ëª©ì ', 'ë¬¼ê±´ì¢…ë¥˜',
                'ì£¼ì†Œ', 'ì§€ë²ˆì£¼ì†Œ', 'ìœ„ë„', 'ê²½ë„', 'ì§€ë²ˆì£¼ì†Œ(2', 'ìœ„ë„(2)', 'ê²½ë„(2)'
            ];
            var vis = {};
            for (var i = 0; i < fields.length; i++) vis[fields[i]] = true; // ê¸°ë³¸: ëª¨ë‘ í‘œì‹œ
            return { fields: fields, visible: vis };
        })();

        // ë¼ë²¨(ì§€ë„ ìœ„ í…ìŠ¤íŠ¸)ì— í‘œì‹œí•  í•„ë“œë³„ í† ê¸€ ì„¤ì •
        // - qgis2web ê¸°ë³¸ ë¼ë²¨ì‹: ì œì¶œì²˜(Tar) / ë‹´ë‹¹ì / ì˜ë¢°ì¼ì / ìƒíƒœ / ì£¼ì†Œ
        var labelFieldConfig_map_data = (function() {
            var fields = ['ì œì¶œì²˜(Tar', 'ë‹´ë‹¹ì', 'ì˜ë¢°ì¼ì', 'ìƒíƒœ', 'ì£¼ì†Œ'];
            var vis = {};
            for (var i = 0; i < fields.length; i++) vis[fields[i]] = true;
            return { fields: fields, visible: vis };
        })();

		function buildPopupContent_map_data(feature) {
		    function fmt(v) {
		        if (v === null || v === undefined) return '';
		        return autolinker.link(String(v).replace(/'/g, '\'').toLocaleString());
		    }
		    
		    // ë³€ìˆ˜ ì„ ì–¸ì„ ë§¨ ìœ„ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.
		    var props = feature.properties || {};
		    var rows = '';
		
		    // ì‚¬ì§„ ë¡œì§ (ê°ì •ì„œë²ˆí˜¸ ê¸°ì¤€)
		    if (props['ê°ì •ì„œë²ˆí˜¸']) { 
		        var id = String(props['ê°ì •ì„œë²ˆí˜¸']).trim();
		        // .jpgì™€ .png ë‘˜ ë‹¤ ì‹œë„í•˜ê²Œ í•˜ê±°ë‚˜, ë³€í™˜í•˜ì‹  .jpgë¡œ ê³ ì •í•©ë‹ˆë‹¤.
		        var imgPath = "images/" + id + ".jpg"; 
		        
		        rows += '<tr><td colspan="2" class="popup-image-container" style="text-align:center;">' +
		                '<img src="' + imgPath + '" ' +
		                'style="width:100%; max-height:250px; object-fit:contain; border-radius:8px; margin-bottom:10px;" ' +
		                'onerror="this.src=\'images/' + id + '.png\'; this.onerror=function(){this.style.display=\'none\'};">' + 
		                '</td></tr>';
		    }
		
		    var cfg = popupFieldConfig_map_data;
		    for (var i = 0; i < cfg.fields.length; i++) {
		        var key = cfg.fields[i];
		        if (!cfg.visible[key]) continue;
		        var val = props[key];
		        if (val === null || val === undefined || val === '') continue;
		        rows += '<tr><th style="min-width:80px; text-align:left;">' + key + '</th><td>' + fmt(val) + '</td></tr>';
		    }
		    
		    return '<table style="width:100%; border-collapse:collapse;">' + 
		           (rows || '<tr><td>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>') + 
		           '</table>';
		}

        function buildLabelContent_map_data(feature) {
            var cfg = labelFieldConfig_map_data;
            var props = feature && feature.properties ? feature.properties : feature;
            if (!props) return '';
            var parts = [];
            for (var i = 0; i < cfg.fields.length; i++) {
                var key = cfg.fields[i];
                if (!cfg.visible[key]) continue;
                var v = props[key];
                if (v === null || v === undefined || v === '') continue;
                parts.push(String(v));
            }
            if (!parts.length) return '';
            var multi = parts.length > 1;
            var cls = multi ? 'q2w-label q2w-label--multi' : 'q2w-label q2w-label--single';
            var sep = multi ? '\n' : ' ';
            return '<div class="' + cls + '" style="color:#ffffff; font-size:10pt; font-family:\'Open Sans\', sans-serif;">' +
                parts.join(sep) +
                '</div>';
        }
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
       function pop_map_data(feature, layer) {
		    // 1. íŒì—… ì—°ê²° (ê°€ë¦¼íŒ ê´€ë ¨ ë¡œì§ ì‚­ì œ)
		    layer.bindPopup(function(l) {
		        return buildPopupContent_map_data(l.feature);
		    }, { 
		        maxHeight: 500,
		        minWidth: 400,
		        maxWidth: 450,
		        offset: [0, -10], // ë§ˆì»¤ì—ì„œ ì‚´ì§ ìœ„ë¡œ ë„ì›€
		        className: 'custom-popup-styled' // í´ë˜ìŠ¤ëª… ë³€ê²½
		    });
		
		    // 2. ë¯¸ë””ì–´ ì²´í¬ ë¡œì§ë§Œ ìœ ì§€
		    layer.on('popupopen', function(e) {
		        addClassToPopupIfMedia(e.popup.getContent(), e.popup);
		        
		        // ì‚¬ì§„ì´ ë¡œë“œë˜ë©´ íŒì—… ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•´ì£¼ëŠ” ì•ˆì „ì¥ì¹˜
		        var img = e.popup._container.querySelector('img');
		        if (img) {
		            img.onload = function() {
		                e.popup.update();
		            };
		        }
		    });
		}

        function style_map_data_0() {
            return {
                pane: 'pane_map_data',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(133,182,111,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_map_data');
        map.getPane('pane_map_data').style.zIndex = 400;
        map.getPane('pane_map_data').style['mix-blend-mode'] = 'normal';
        var layer_map_data = new L.geoJson(json_map_data, {
            attribution: '',
            interactive: true,
            dataVar: 'json_map_data',
            layerName: 'layer_map_data',
            pane: 'pane_map_data',
            onEachFeature: pop_map_data,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_map_data_0(feature));
            },
        });
        bounds_group.addLayer(layer_map_data);
        map.addLayer(layer_map_data);
        
        // QGIS ë°ì´í„°(ì˜¤ë²„ë ˆì´) í† ê¸€ ì»¨íŠ¸ë¡¤
        // - ë§ˆì»¤(í”¼ì²˜)ì™€ í…ìŠ¤íŠ¸(ë¼ë²¨)ë¥¼ ë¶„ë¦¬ í† ê¸€í•©ë‹ˆë‹¤.
        // - ë¼ë²¨ì€ Leaflet tooltip paneì„ ìˆ¨ê¸°ëŠ” "í† ê¸€ìš© ë ˆì´ì–´"ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.
        var LabelToggleLayer = L.Layer.extend({
            onAdd: function(m) {
                m.getContainer().classList.remove('labels-hidden');
            },
            onRemove: function(m) {
                m.getContainer().classList.add('labels-hidden');
            }
        });
        var layer_labels_map_data = new LabelToggleLayer();
        // ê¸°ë³¸ê°’: ë¼ë²¨ í‘œì‹œ(ì²´í¬ëœ ìƒíƒœ)
        layer_labels_map_data.addTo(map);

        L.control.layers(
            null,
            {
                'ë§ˆì»¤': layer_map_data,
                'í…ìŠ¤íŠ¸(ë¼ë²¨)': layer_labels_map_data
            },
            { collapsed: false, position: 'topright' }
        ).addTo(map);

        // ë¼ë²¨(í…ìŠ¤íŠ¸) í•„ë“œë³„ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ ì»¨íŠ¸ë¡¤
        (function addLabelFieldToggleControl() {
            var Control = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function(m) {
                    var div = L.DomUtil.create('div', 'popup-field-toggle');
                    div.innerHTML = [
                        '<div class="title">ë¼ë²¨ í•„ë“œ í† ê¸€</div>',
                        '<div class="actions">',
                        '  <button type="button" data-action="all">ì „ì²´</button>',
                        '  <button type="button" data-action="none">í•´ì œ</button>',
                        '</div>',
                        '<div class="list"></div>'
                    ].join('');

                    L.DomEvent.disableClickPropagation(div);
                    L.DomEvent.disableScrollPropagation(div);

                    var list = div.querySelector('.list');
                    var cfg = labelFieldConfig_map_data;

                    function refreshLabels() {
                        var idx = 0;
                        layer_map_data.eachLayer(function(lyr) {
                            var tt = (lyr.getTooltip && lyr.getTooltip()) ? lyr.getTooltip() : null;
                            if (tt) {
                                tt.setContent(buildLabelContent_map_data(lyr.feature));
                            }
                            idx++;
                        });
                        // labelgun ì¬ê³„ì‚°
                        resetLabels([layer_map_data]);
                    }

                    for (var i = 0; i < cfg.fields.length; i++) {
                        var key = cfg.fields[i];
                        var id = 'labelfield_' + i;
                        var row = document.createElement('label');
                        row.innerHTML = '<input type="checkbox" id="' + id + '" checked> <span>' + key + '</span>';
                        (function(k, checkbox) {
                            checkbox.addEventListener('change', function() {
                                cfg.visible[k] = !!checkbox.checked;
                                refreshLabels();
                            });
                        })(key, row.querySelector('input'));
                        list.appendChild(row);
                    }

                    div.querySelector('[data-action="all"]').addEventListener('click', function() {
                        for (var i = 0; i < cfg.fields.length; i++) cfg.visible[cfg.fields[i]] = true;
                        var inputs = list.querySelectorAll('input[type="checkbox"]');
                        for (var j = 0; j < inputs.length; j++) inputs[j].checked = true;
                        refreshLabels();
                    });
                    div.querySelector('[data-action="none"]').addEventListener('click', function() {
                        for (var i = 0; i < cfg.fields.length; i++) cfg.visible[cfg.fields[i]] = false;
                        var inputs = list.querySelectorAll('input[type="checkbox"]');
                        for (var j = 0; j < inputs.length; j++) inputs[j].checked = false;
                        refreshLabels();
                    });

                    return div;
                }
            });
            map.addControl(new Control());
        })();
        setBounds();
        var i = 0;
        layer_map_data.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            // ë¼ë²¨ì€ í•„ë“œë³„ í† ê¸€ ì„¤ì •ì„ ë°˜ì˜í•´ ìƒì„±
            layer.bindTooltip(buildLabelContent_map_data(layer.feature), {permanent: true, offset: [-0, -16], className: 'css_map_data'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        resetLabels([layer_map_data]);
        map.on("zoomend", function(){
            resetLabels([layer_map_data]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_map_data]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_map_data]);
        });

		// --- ë™ì  ê²€ìƒ‰ í•„í„° ë¡œì§ ì‹œì‘ ---
       function applyMultiFilter() {
		    // ëª¨ë“  ì…ë ¥ì°½ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
		    var filterInputs = document.querySelectorAll('.multi-filter-input');
		    var activeFilters = [];
		
		    // í˜„ì¬ ì…ë ¥ê°’ì´ ìˆëŠ” í•„í„°ë“¤ë§Œ ì¶”ì¶œ
		    filterInputs.forEach(function(input) {
		        if (input.value.trim() !== "") {
		            activeFilters.push({
		                field: input.getAttribute('data-field'),
		                value: input.value.toLowerCase().trim()
		            });
		        }
		    });
		
		    var visibleCount = 0;
		
		    layer_map_data.eachLayer(function(layer) {
		        var props = layer.feature.properties;
		        
		        // every() í•¨ìˆ˜ëŠ” ëª¨ë“  ì¡°ê±´ì´ ì°¸(true)ì¼ ë•Œë§Œ trueë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤ (AND ì¡°ê±´)
		        var isMatch = activeFilters.every(function(filter) {
		            var dataValue = String(props[filter.field] || "").toLowerCase();
		            return dataValue.includes(filter.value);
		        });
		
		        if (isMatch) {
		            if (!map.hasLayer(layer)) map.addLayer(layer);
		            visibleCount++;
		        } else {
		            if (map.hasLayer(layer)) map.removeLayer(layer);
		        }
		    });
		
		    // ê²°ê³¼ ê±´ìˆ˜ ì—…ë°ì´íŠ¸
		    document.getElementById('filter-result-count').innerText = "ê²€ìƒ‰ ê²°ê³¼: " + visibleCount + "ê±´";
		
		    if (typeof resetLabels === "function") {
		        resetLabels([layer_map_data]);
		    }
		}
		
		// ëª¨ë“  ì…ë ¥ì°½ì— ì´ë²¤íŠ¸ ì—°ê²°
		document.querySelectorAll('.multi-filter-input').forEach(function(input) {
		    input.addEventListener('input', applyMultiFilter);
		});
		function exportToExcel() {
		    var data = [];
		    var headers = ['ê°ì •ì„œë²ˆí˜¸', 'ë‹´ë‹¹ì', 'ì œì¶œì²˜', 'ì£¼ì†Œ', 'ë¬¼ê±´ì¢…ë¥˜', 'ìƒíƒœ']; // ì—‘ì…€ì— í¬í•¨í•  í•„ë“œëª…ë“¤
		
		    // 1. í—¤ë” ì¶”ê°€
		    data.push(headers.join(','));
		
		    // 2. í˜„ì¬ ì§€ë„ì— ë³´ì´ëŠ” ë§ˆì»¤ë“¤ì˜ ë°ì´í„° ì¶”ì¶œ
		    layer_map_data.eachLayer(function(layer) {
		        if (map.hasLayer(layer)) {
		            var props = layer.feature.properties;
		            var row = headers.map(function(header) {
		                // ë°ì´í„° ë‚´ì— ì‰¼í‘œ(,)ê°€ ìˆìœ¼ë©´ ì—‘ì…€ í˜•ì‹ì´ ê¹¨ì§€ë¯€ë¡œ ì œê±°í•˜ê±°ë‚˜ í°ë”°ì˜´í‘œ ì²˜ë¦¬
		                var val = String(props[header] || "").replace(/,/g, " ");
		                return '"' + val + '"'; 
		            });
		            data.push(row.join(','));
		        }
		    });
		
		    if (data.length <= 1) {
		        alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }
		
		    // 3. íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ (í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ BOM ì¶”ê°€)
		    var csvContent = "\uFEFF" + data.join("\n");
		    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
		    var url = URL.createObjectURL(blob);
		    
		    var link = document.createElement("a");
		    link.setAttribute("href", url);
		    link.setAttribute("download", "ê²€ìƒ‰ê²°ê³¼_" + new Date().toLocaleDateString() + ".csv");
		    document.body.appendChild(link);
		    link.click();
		    document.body.removeChild(link);
		}
		// ì¹´ì¹´ì˜¤ ë ˆì´ì–´ í† ê¸€ ë¡œì§ (ìˆ˜ì • ë²„ì „)
		document.querySelectorAll('.kakao-layer-toggle').forEach(function(checkbox) {
		    checkbox.addEventListener('change', function(e) {
		        var layerType = e.target.getAttribute('data-type');
		        
		        // 1. ì „ì—­ ë³€ìˆ˜ì—ì„œ ì¹´ì¹´ì˜¤ ì§€ë„ ê°ì²´ í›„ë³´ë“¤ì„ ì°¾ìŠµë‹ˆë‹¤.
		        // qgis2web ì»¤ìŠ¤í…€ ì„¤ì •ì— ë”°ë¼ k_map, kakao_map, map ë“±ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
		        var targetMap = window.kakaoMap || window.k_map || window.kakao_map;
		
		        if (targetMap && targetMap.addOverlayMapTypeId) {
		            if (e.target.checked) {
		                targetMap.addOverlayMapTypeId(kakao.maps.MapTypeId[layerType]);
		            } else {
		                targetMap.removeOverlayMapTypeId(kakao.maps.MapTypeId[layerType]);
		            }
		        } else {
		            console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ë³€ìˆ˜ëª…ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
		            // íŒ: ë§Œì•½ ê·¸ë˜ë„ ì•ˆëœë‹¤ë©´ ì½˜ì†”ì°½ì— 'window'ë¼ê³  ì³ì„œ kë¡œ ì‹œì‘í•˜ëŠ” ê°ì²´ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.
		        }
		    });
		});
		// ì™¸ë¶€ JSON íŒŒì¼ì„ ë‹´ì„ ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
		var externalLayerGroup = L.featureGroup().addTo(map);
		
		// 1. ì™¸ë¶€ ë°ì´í„° ì „ìš© ì „ì—­ ë³€ìˆ˜ ì„¤ì •
		var externalLabelConfig = { fields: [], visible: {} };
		var currentExternalLayer = null;
		var externalLayerGroup = L.featureGroup().addTo(map);
		
		document.getElementById('external-geojson-input').addEventListener('change', function(e) {
		    var file = e.target.files[0];
		    if (!file) return;
		
		    var reader = new FileReader();
		    reader.onload = function(event) {
		        try {
		            var geojsonData = JSON.parse(event.target.result);
		            
		            // ê¸°ì¡´ ë ˆì´ì–´ ë° UI ì´ˆê¸°í™”
		            externalLayerGroup.clearLayers();
		            var oldUI = document.getElementById('external-label-controls');
		            if (oldUI) oldUI.remove();
		
		            // 2. ì™¸ë¶€ ë°ì´í„°ì˜ í•„ë“œ(Key) ìë™ ì¶”ì¶œ ë° ì´ˆê¸° ì„¤ì •
		            if (geojsonData.features && geojsonData.features.length > 0) {
		                var firstProps = geojsonData.features[0].properties;
		                externalLabelConfig.fields = Object.keys(firstProps);
		                externalLabelConfig.fields.forEach(function(f) {
		                    externalLabelConfig.visible[f] = true; // ì´ˆê¸°ê°’ì€ ëª¨ë‘ í‘œì‹œ
		                });
		                
		                // ì „ìš© í† ê¸€ UI ìƒì„±
		                createExternalToggleUI(file.name);
		            }
		
		            // 3. ë ˆì´ì–´ ìƒì„±
		            currentExternalLayer = L.geoJson(geojsonData, {
		                onEachFeature: function(feature, layer) {
		                    pop_map_data(feature, layer); // ê¸°ì¡´ íŒì—… í•¨ìˆ˜ ì¬í™œìš©
		                    renderExternalLabel(layer);   // ì™¸ë¶€ ì „ìš© ë¼ë²¨ ë Œë”ë§
		                },
		                pointToLayer: function (feature, latlng) {
		                    return L.circleMarker(latlng, {
		                        radius: 7,
		                        fillColor: "#ff7800", // ì™¸ë¶€ ë°ì´í„°ëŠ” ì£¼í™©ìƒ‰
		                        color: "#fff",
		                        weight: 2,
		                        fillOpacity: 0.9
		                    });
		                }
		            });
		
		            externalLayerGroup.addLayer(currentExternalLayer);
		            
		            // 4. ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ë“±ë¡ (ìš°ì¸¡ ìƒë‹¨ íŒ¨ë„)
		            var lControl = window.layerControl || window.controlLayers || window.control;
		            if (lControl) lControl.addOverlay(externalLayerGroup, "ğŸ“‚ " + file.name);
		
		            // 5. ìœ„ì¹˜ ì´ë™
		            map.fitBounds(currentExternalLayer.getBounds());
		            alert("'" + file.name + "' ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! í•˜ë‹¨ì—ì„œ ë¼ë²¨ì„ ì„¤ì •í•˜ì„¸ìš”.");
		
		        } catch (err) {
		            console.error(err);
		            alert("JSON ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		        }
		    };
		    reader.readAsText(file);
		});
		
		// --- [í•¨ìˆ˜] ì™¸ë¶€ ë°ì´í„° ì „ìš© ë¼ë²¨ ë Œë”ë§ ---
		function renderExternalLabel(layer) {
		    var parts = [];
		    externalLabelConfig.fields.forEach(function(f) {
		        if (externalLabelConfig.visible[f] && layer.feature.properties[f]) {
		            parts.push(String(layer.feature.properties[f]));
		        }
		    });
		
		    if (parts.length > 0) {
		        layer.bindTooltip('<div style="text-align:center; font-weight:bold; font-size:10pt;">' + parts.join('<br>') + '</div>', {
		            permanent: true,
		            offset: [0, -12],
		            direction: 'top',
		            className: 'css_map_data' // ê¸°ì¡´ ë¼ë²¨ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©
		        }).openTooltip();
		    } else {
		        layer.unbindTooltip();
		    }
		}
		
		// --- [í•¨ìˆ˜] ì™¸ë¶€ ë°ì´í„° ì „ìš© í† ê¸€ UI ìƒì„± ---
		function createExternalToggleUI(fileName) {
		    var parent = document.getElementById('external-geojson-input').parentNode;
		    var ui = document.createElement('div');
		    ui.id = 'external-label-controls';
		    ui.style = "margin-top:10px; padding:12px; background:#fff9f0; border-radius:10px; border:1px solid #ffcc80; max-height:200px; overflow-y:auto;";
		    
		    var title = '<div style="font-size:11px; font-weight:bold; color:#e65100; margin-bottom:8px;">ğŸ“ ì™¸ë¶€ ë¼ë²¨ í•„ë“œ ì„ íƒ (' + fileName + ')</div>';
		    var listHtml = externalLabelConfig.fields.map(function(f) {
		        return '<label style="display:block; font-size:11px; margin-bottom:3px; cursor:pointer;">' +
		               '<input type="checkbox" class="ext-chk" data-field="' + f + '" checked> ' + f + '</label>';
		    }).join('');
		
		    ui.innerHTML = title + listHtml;
		    parent.appendChild(ui);
		
		    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë°”ì¸ë”©
		    ui.querySelectorAll('.ext-chk').forEach(function(chk) {
		        chk.addEventListener('change', function() {
		            externalLabelConfig.visible[this.dataset.field] = this.checked;
		            if (currentExternalLayer) {
		                currentExternalLayer.eachLayer(function(lyr) { renderExternalLabel(lyr); });
		            }
		        });
		    });
		}
        </script>        
    </body>
</html>
