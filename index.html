<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #kakao-map, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        /* ì¹´ì¹´ì˜¤ì§€ë„ë¥¼ ë°°ê²½ìœ¼ë¡œ ë‘ê³ , Leafletì€ ê·¸ ìœ„ì— ì˜¤ë²„ë ˆì´ë¡œ ì˜¬ë¦½ë‹ˆë‹¤. */
        #kakao-map, #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #kakao-map {
            z-index: 0;
        }
        #map {
            z-index: 1;
            background: transparent;
        }
        /* íŒì—…(ì†ì„±í‘œ) ê°€ë…ì„± ê°œì„  */
        .leaflet-popup-content table {
            border-collapse: collapse;
            width: 100%;
        }
        .leaflet-popup-content th,
        .leaflet-popup-content td {
            padding: 2px 6px;
            vertical-align: top;
            word-break: break-word;
            white-space: normal;
        }
        .leaflet-popup-content th {
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0.85;
        }
        /* íŒì—… í•„ë“œ í† ê¸€ ì»¨íŠ¸ë¡¤ UI */
        .popup-field-toggle {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            max-height: 45vh;
            overflow: auto;
            font: 12px/1.2 Arial, Helvetica, sans-serif;
        }
        .popup-field-toggle .title {
            font-weight: 700;
            margin-bottom: 6px;
        }
        .popup-field-toggle .actions {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .popup-field-toggle .actions button {
            font-size: 11px;
            padding: 2px 6px;
            cursor: pointer;
        }
        .popup-field-toggle label {
            display: flex;
            gap: 6px;
            align-items: center;
            margin: 3px 0;
            cursor: pointer;
            user-select: none;
        }
        /* ë¼ë²¨(íˆ´íŒ) í­/ì¤„ë°”ê¿ˆ ì œì–´ */
        .leaflet-tooltip.css_map_data {
            /* ê¸°ë³¸ leaflet max-width ë•Œë¬¸ì— ê¸€ìê°€ ì„¸ë¡œë¡œ êº¾ì´ëŠ” í˜„ìƒ ë°©ì§€ */
            max-width: none !important;
            width: max-content; /* ê°€ëŠ¥í•˜ë©´ ë‚´ìš©ë§Œí¼ ê°€ë¡œë¡œ í™•ì¥ */
            white-space: normal; /* ì‹¤ì œ ì¤„ë°”ê¿ˆì€ ë‚´ë¶€ .q2w-labelì´ ì œì–´ */

			color: #000000 !important;      /* ê¸€ììƒ‰ì„ ê²€ì •ìœ¼ë¡œ */
        	font-weight: bold;              /* (ì„ íƒ) ê¸€ìë¥¼ ë” ì§„í•˜ê²Œ í•˜ë ¤ë©´ ì¶”ê°€ */
    		text-shadow: 1px 1px 2px white; /* (ì„ íƒ) ê²€ì€ ê¸€ì”¨ê°€ ë” ì˜ ë³´ì´ê²Œ í°ìƒ‰ ì™¸ê³½ì„  ì¶”ê°€ */
        }
        .leaflet-tooltip.css_map_data .q2w-label {
			color : #000000 !important;
            display: inline-block;
            max-width: none !important;
        }
        .q2w-label.q2w-label--single {
            white-space: nowrap; /* 1ê°œ í•„ë“œì¼ ë•ŒëŠ” ê°€ë¡œë¡œ */
        }
        .q2w-label.q2w-label--multi {
            white-space: pre-line; /* 2ê°œ ì´ìƒì´ë©´ ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
        /* ë¼ë²¨(íˆ´íŒ) í† ê¸€ì„ ìœ„í•œ CSS */
        .labels-hidden .leaflet-tooltip-pane {
            display: none;
        }
		/* íŒì—… ê°€ë¡œ ë„“ì´ ë° ë””ìì¸ ìˆ˜ì • */
		.leaflet-popup-content-wrapper {
		    width: 450px !important;    /* ìƒì ì „ì²´ ë„ˆë¹„ (ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì •) */
		    border: 2px solid #0000ff;  /* ì•„ê¹Œ ì›í•˜ì…¨ë˜ íŒŒë€ í…Œë‘ë¦¬ ì¶”ê°€ */
		}
		
		.leaflet-popup-content {
		    width: 420px !important;    /* ì‹¤ì œ ë‚´ìš©ì´ ë“¤ì–´ê°€ëŠ” ë„ˆë¹„ (wrapperë³´ë‹¤ ì•½ê°„ ì‘ê²Œ) */
		}

				/* ê²€ìƒ‰ì°½ ì»¨í…Œì´ë„ˆ ë””ìì¸ */
		.search-filter-container {
		    position: absolute;
		    top: 15px;      /* ìœ„ì¹˜ ì¡°ì • */
		    left: 60px;     /* ì¤Œ ì»¨íŠ¸ë¡¤ ì˜† */
		    z-index: 1000;
		    display: flex;
		    gap: 5px;
		}
		
		.search-filter-input {
		    width: 200px;
		    padding: 8px 12px;
		    border: 2px solid #0051af;
		    border-radius: 20px;
		    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
		    outline: none;
		    font-size: 14px;
		}
		
		.search-filter-input:focus {
		    background-color: #f0f7ff;
		}
		
		/* íŒì—… í™”ë©´ ì¤‘ì•™ ê³ ì • */
		.custom-central-popup.leaflet-popup {
			z-index: 10000 !important; /* ê°€ë¦¼íŒ(1000)ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
		}
		
		
		/* íŒì—… ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
		.popup-image-container img {
		    width: 100%;
		    max-height: 300px;
		    object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê²Œ */
		    border-radius: 8px;
		    margin-bottom: 10px;
		}


		<style>
		    #map, #kakao-map { left: 350px !important; width: calc(100% - 350px) !important; }
		    .list-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
		    .list-item:hover { background: #f0f7ff; }
		    .list-item .title { font-weight: bold; font-size: 15px; margin-bottom: 5px; }
		    .list-item .price { color: #d32f2f; font-weight: bold; }
		    .list-item .info { font-size: 13px; color: #666; margin-top: 5px; }
		<style>

		<style>
		    /* 1. Leaflet ê¸°ë³¸ íˆ´íŒ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ì œê±° */
		    .leaflet-tooltip.css_map_data_B,
		    .leaflet-tooltip.css_map_data_C {
		        background-color: transparent !important;
		        border: none !important;
		        box-shadow: none !important;
		        padding: 0 !important;
		        /* ë‚´ìš©ì´ ì•„ì˜ˆ ì—†ì„ ë•Œ(ì²´í¬ í•´ì œ ì‹œ) ë°•ìŠ¤ í…Œë‘ë¦¬ê°€ ë‚¨ëŠ” í˜„ìƒ ë°©ì§€ */
		        display: block !important; 
		    }
		
		    /* 2. ë‚´ë¶€ ë°•ìŠ¤ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì•„ì˜ˆ ìˆ¨ê¹€ ì²˜ë¦¬ */
		    .custom-tooltip-box:empty {
		        display: none !important;
		    }
		
		    /* 3. ìš°ë¦¬ê°€ ë§Œë“  ë‚´ë¶€ ë°•ìŠ¤ ë””ìì¸ */
		    .custom-tooltip-box {
		        background-color: #ffffff !important;
		        border: 2px solid #3388ff !important;
		        border-radius: 8px !important;
		        padding: 10px 14px !important;
		        box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important;
		        text-align: center;
		        min-width: 100px;
		        /* ë°•ìŠ¤ ì•ˆì˜ ê¸€ìê°€ ë„ˆë¬´ ë§ì•„ì§€ë©´ ìë™ ì¤„ë°”ê¿ˆ í—ˆìš© (ì„ íƒ ì‚¬í•­) */
		        max-width: 250px; 
		    }
		
		    /* 4. í‘íšŒìƒ‰ í…ìŠ¤íŠ¸ í•„ë“œ ìŠ¤íƒ€ì¼ */
		    .text-main {
		        font-weight: bold !important;
		        color: #1a202c !important;
		        font-size: 13px !important;
		        margin-bottom: 2px;
		        white-space: nowrap;
		        overflow: hidden;
		        text-overflow: ellipsis; /* ê¸€ìê°€ ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬ */
		    }
		
		    /* 5. ê¸ˆì•¡ í•„ë“œ ìŠ¤íƒ€ì¼ (ìƒë‹¨ êµ¬ë¶„ì„  í¬í•¨) */
		    .text-price {
		        font-weight: 900 !important;
		        color: #e53e3e !important;
		        font-size: 15px !important;
		        margin-top: 6px;
		        border-top: 1px solid #edf2f7;
		        padding-top: 6px;
		        white-space: nowrap;
		    }
		
		    /* 6. ê¸ˆì•¡ë§Œ ì¼œì ¸ ìˆì„ ê²½ìš° ìƒë‹¨ í…Œë‘ë¦¬ ì œê±° (ë””í…Œì¼) */
		    .text-price:first-child {
		        border-top: none !important;
		        margin-top: 0 !important;
		        padding-top: 0 !important;
		    }
		
		    /* 7. ì „ì²´ ë¼ë²¨ ìˆ¨ê¹€ í† ê¸€ ì—°ë™ */
		    .labels-hidden .css_map_data_B,
		    .labels-hidden .css_map_data_C {
		        display: none !important;
		    }
		
		    /* 8. íˆ´íŒ í™”ì‚´í‘œ ìˆ¨ê¹€ */
		    .leaflet-tooltip-top.css_map_data_B:before,
		    .leaflet-tooltip-top.css_map_data_C:before {
		        display: none !important;
		    }
		</style>
        <title></title>
    </head>
    <body>
		<div id="side-dashboard" style="position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
		    <div style="padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa;">
		        <h2 style="margin: 0; font-size: 18px; color: #333;">ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ <span id="list-count" style="color: #0051af;">0</span></h2>
		    </div>
		    <div id="list-container" style="flex: 1; overflow-y: auto; padding: 10px;">
		        </div>
		</div>
        <div id="kakao-map"></div>
		<div id="map"></div>
		<!-- ë¡œë“œë·° íŒ¨ë„ -->
		<div id="roadview-panel" style="display:none; position:fixed; bottom:0; left:350px; right:0; height:35%; z-index:2000; background:#000; border-top:3px solid #0051af;">
		    <div style="position:absolute; top:0; left:0; right:0; height:32px; background:#0051af; display:flex; align-items:center; padding:0 12px; z-index:1;">
		        <span style="color:white; font-size:13px; font-weight:bold;">ğŸ“· ë¡œë“œë·°</span>
		        <span id="roadview-address" style="color:#cce4ff; font-size:12px; margin-left:10px;"></span>
		        <button onclick="closeRoadview()" style="margin-left:auto; background:transparent; border:none; color:white; font-size:18px; cursor:pointer; line-height:1;">âœ•</button>
		    </div>
		    <div id="roadview" style="position:absolute; top:32px; left:0; right:0; bottom:0;"></div>
		</div>

		<div class="filter-panel" style="position: fixed; top: 20px; left: 370px; z-index: 2000; background: white; padding: 10px 14px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 700px; font-family: sans-serif;">
		    
		    <!-- íƒ€ì´í‹€ í–‰ -->
		    <div style="display: flex; align-items: center; margin-bottom: 8px;">
		        <h4 style="margin: 0; font-size: 13px; color: #333;">ìƒì„¸ í•„í„°</h4>
		        <span id="filter-layer-badge" style="font-size:11px; color:#fff; background:#0051af; padding:2px 7px; border-radius:10px; margin-left:8px;">A ë°ì´í„°</span>
		        <span id="filter-result-count" style="font-size:12px; color:#0051af; font-weight:bold; margin-left:auto;"></span>
		        <button onclick="exportToExcel()" style="margin-left:10px; padding:4px 10px; background-color:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; font-size:11px; white-space:nowrap;">
		            ğŸ“Š ì—‘ì…€ ì €ì¥
		        </button>
		    </div>
		
		    <!-- í•„í„° ì…ë ¥ì°½ (í•œ ì¤„ ê°€ë¡œ ë°°ì¹˜) -->
		    <div id="dynamic-filter-inputs" style="display:flex; flex-wrap:nowrap; gap:6px; align-items:flex-end;"></div>
		
		    <!-- ë¶€ê°€ ê¸°ëŠ¥ í–‰ (í•œ ì¤„) -->
		    <div style="display:flex; align-items:center; gap:16px; margin-top:8px; padding-top:8px; border-top:1px solid #eee; flex-wrap:wrap;">
		        
		        <!-- ì§€ë„ ë¶€ê°€ ê¸°ëŠ¥ -->
		        <div style="display:flex; align-items:center; gap:10px; font-size:12px;">
		            <span style="font-size:11px; font-weight:bold; color:#555; white-space:nowrap;">ğŸ—ºï¸ ì§€ë„</span>
		            <label style="display:flex; align-items:center; gap:3px; cursor:pointer; white-space:nowrap;">
		                <input type="checkbox" class="kakao-layer-toggle" data-type="USE_DISTRICT"> ì§€ì í¸ì§‘ë„
		            </label>
		            <label style="display:flex; align-items:center; gap:3px; cursor:pointer; white-space:nowrap;">
		                <input type="checkbox" class="kakao-layer-toggle" data-type="TRAFFIC"> ğŸš¦ êµí†µ
		            </label>
		            <label style="display:flex; align-items:center; gap:3px; cursor:pointer; white-space:nowrap;">
		                <input type="checkbox" class="kakao-layer-toggle" data-type="ROADVIEW"> ğŸ“· ë¡œë“œë·°
		            </label>
		        </div>
		
		        <!-- êµ¬ë¶„ì„  -->
		        <div style="width:1px; height:18px; background:#ddd;"></div>
		
		        <!-- ì™¸ë¶€ GeoJSON -->
		        <div style="display:flex; align-items:center; gap:6px; font-size:12px;">
		            <span style="font-size:11px; font-weight:bold; color:#0051af; white-space:nowrap;">ğŸ“‚ GeoJSON</span>
		            <input type="file" id="external-geojson-input" accept=".json,.geojson" style="font-size:11px;">
		        </div>
		
		    </div>
		    <div id="external-label-controls"></div>
		</div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=231190ac1aca72ada0b739110d8a0eb4"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/kakao_base.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/map_data.js"></script>
		<script src="data/B_data.js"></script>
		<script src="data/C_data.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[37.43966984122166,126.86818683641245],[37.6101521616503,127.1412179712234]]);
        // Kakao Roadmap(ì¼ë°˜ì§€ë„/Street) ë°°ê²½ì§€ë„ ì´ˆê¸°í™” + Leaflet ë·° ë™ê¸°í™”
        initKakaoBaseMap(map, { mapTypeId: 'ROADMAP' });
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // íŒì—…ì— í‘œì‹œí•  í•„ë“œ(ì†ì„±)ë³„ í† ê¸€ ì„¤ì •
        var popupFieldConfig_map_data = (function() {
            var fields = [
                'ê°ì •ì„œë²ˆí˜¸', 'ë³¸ì‚¬/ì§€ì‚¬', 'ë‹´ë‹¹ì', 'í‰ê°€ì‚¬', 'ê±´ëª…', 'ê±°ë˜ì²˜ëª…', 'ì˜ë¢°ì¸', 'ìƒíƒœ',
                'ì˜ë¢°ì¼ì', 'ë°œì†¡ì¼ì', 'ì†Œìœ ìì „í™”', 'ì±„ë¬´ì', 'ì±„ë¬´ìì „í™”', 'ì˜ë¢°ë¬¸ì„œë²ˆ', 'ì˜ë¢°ë¶€ì„œ',
                'ì œì¶œì²˜', 'ì œì¶œì²˜(Tar', 'ì œì¶œì²˜(T_1', 'ì œì¶œì²˜(T_2', 'ì†Œìœ ì', 'í‰ê°€ëª©ì ', 'ë¬¼ê±´ì¢…ë¥˜',
                'ì£¼ì†Œ', 'ì§€ë²ˆì£¼ì†Œ', 'ìœ„ë„', 'ê²½ë„', 'ì§€ë²ˆì£¼ì†Œ(2', 'ìœ„ë„(2)', 'ê²½ë„(2)'
            ];
            var vis = {};
            for (var i = 0; i < fields.length; i++) vis[fields[i]] = true; // ê¸°ë³¸: ëª¨ë‘ í‘œì‹œ
            return { fields: fields, visible: vis };
        })();

		// B ë°ì´í„°ìš© í•„ë“œ ì„¤ì •
		var labelFieldConfig_B_data = {
		    fields: ["ì—°ë²ˆ", "ì†Œì¬ì§€(í†µ", "êµ¬ë¶„", "ì„¸ë¶€ìš©ë„", "ë³´ì¦ê¸ˆ/ì›”", "ì˜ë¢°ê¸ˆì•¡(", "(ë‹¨ìˆœ)ì˜ˆìƒ"],
		    visible: {
		        "ì—°ë²ˆ": false, "ì†Œì¬ì§€(í†µ": true, "êµ¬ë¶„": true, "ì„¸ë¶€ìš©ë„": true, 
		        "ë³´ì¦ê¸ˆ/ì›”": true, "ì˜ë¢°ê¸ˆì•¡(": true, "(ë‹¨ìˆœ)ì˜ˆìƒ": true
		    }
		};

		// C ë°ì´í„°ìš© í•„ë“œ ì„¤ì • (C_data.jsì˜ ì‹¤ì œ í•„ë“œëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
		var labelFieldConfig_C_data = {
		    fields: ["ë¬¼ë¥˜ì„¼í„°ëª…", "ì†Œì¬ì§€", "êµ¬ë¶„", "ì—°ë©´ì (Py)", "ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)", "ì£¼ìš” ì„ì°¨ì¸"],
		    visible: {
		        "ë¬¼ë¥˜ì„¼í„°ëª…": true, "ì†Œì¬ì§€": true, "êµ¬ë¶„": true, 
		        "ì—°ë©´ì (Py)": true, "ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)": true, "ì£¼ìš” ì„ì°¨ì¸": true
		    }
		};
		
		// B ë°ì´í„°ìš© ë¼ë²¨ ë‚´ìš© ìƒì„± í•¨ìˆ˜
		function buildLabelContent_B_data(feature) {
		    var cfg = labelFieldConfig_B_data;
		    var p = feature.properties;
		    var activeFields = [];
		
		    if (cfg.visible["ì†Œì¬ì§€(í†µ"]) activeFields.push(`<div class="text-main">${p['ì†Œì¬ì§€(í†µ'] || ''}</div>`);
		    if (cfg.visible["êµ¬ë¶„"])       activeFields.push(`<div class="text-main">${p['êµ¬ë¶„'] || ''}</div>`);
		    if (cfg.visible["ì„¸ë¶€ìš©ë„"])   activeFields.push(`<div class="text-main">${p['ì„¸ë¶€ìš©ë„'] || ''}</div>`);
		    if (cfg.visible["ë³´ì¦ê¸ˆ/ì›”"])  activeFields.push(`<div class="text-main">${p['ë³´ì¦ê¸ˆ/ì›”'] || ''}</div>`);
		    if (cfg.visible["(ë‹¨ìˆœ)ì˜ˆìƒ"]) activeFields.push(`<div class="text-main">${p['(ë‹¨ìˆœ)ì˜ˆìƒ'] || ''}</div>`);
		    
		    if (cfg.visible["ì˜ë¢°ê¸ˆì•¡("]) activeFields.push(`<div class="text-price">${p['ì˜ë¢°ê¸ˆì•¡('] || ''}</div>`);
		
		    if (!activeFields.length) return '';
		    return `<div class="custom-tooltip-box">${activeFields.join('')}</div>`;
		}

		// C ë°ì´í„°ìš© ë¼ë²¨ ë‚´ìš© ìƒì„± í•¨ìˆ˜
		function buildLabelContent_C_data(feature) {
		    var cfg = labelFieldConfig_C_data;
		    var p = feature.properties;
		    var activeFields = [];
		
		    if (cfg.visible["ë¬¼ë¥˜ì„¼í„°ëª…"]) activeFields.push(`<div class="text-main">${p['ë¬¼ë¥˜ì„¼í„°ëª…'] || ''}</div>`);
		    if (cfg.visible["ì†Œì¬ì§€"])     activeFields.push(`<div class="text-main">${p['ì†Œì¬ì§€'] || ''}</div>`);
		    if (cfg.visible["êµ¬ë¶„"])       activeFields.push(`<div class="text-main">${p['êµ¬ë¶„'] || ''}</div>`);
		    if (cfg.visible["ì—°ë©´ì (Py)"]) activeFields.push(`<div class="text-main">${p['ì—°ë©´ì (Py)'] || ''}</div>`);
		    if (cfg.visible["ì£¼ìš” ì„ì°¨ì¸"]) activeFields.push(`<div class="text-main">${p['ì£¼ìš” ì„ì°¨ì¸'] || ''}</div>`);
		    
		    if (cfg.visible["ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)"]) activeFields.push(`<div class="text-price">${p['ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)'] || ''}</div>`);
		
		    if (!activeFields.length) return '';
		    return `<div class="custom-tooltip-box">${activeFields.join('')}</div>`;
		}
			
        // ë¼ë²¨(ì§€ë„ ìœ„ í…ìŠ¤íŠ¸)ì— í‘œì‹œí•  í•„ë“œë³„ í† ê¸€ ì„¤ì •
        var labelFieldConfig_map_data = (function() {
            var fields = ['ì œì¶œì²˜(Tar', 'ë‹´ë‹¹ì', 'ì˜ë¢°ì¼ì', 'ìƒíƒœ', 'ì£¼ì†Œ'];
            var vis = {};
            for (var i = 0; i < fields.length; i++) vis[fields[i]] = true;
            return { fields: fields, visible: vis };
        })();

		function buildPopupContent_map_data(feature) {
		    function fmt(v) {
		        if (v === null || v === undefined) return '';
		        return autolinker.link(String(v).replace(/'/g, '\'').toLocaleString());
		    }
		    
		    var props = feature.properties || {};
		    var rows = '';
		
		    if (props['ê°ì •ì„œë²ˆí˜¸']) { 
		        var id = String(props['ê°ì •ì„œë²ˆí˜¸']).trim();
		        var imgPath = "images/" + id + ".jpg"; 
		        
		        rows += '<tr><td colspan="2" class="popup-image-container" style="text-align:center;">' +
		                '<img src="' + imgPath + '" ' +
		                'style="width:100%; max-height:250px; object-fit:contain; border-radius:8px; margin-bottom:10px;" ' +
		                'onerror="this.src=\'images/' + id + '.png\'; this.onerror=function(){this.style.display=\'none\'};">' + 
		                '</td></tr>';
		    }
		
		    var cfg = popupFieldConfig_map_data;
		    for (var i = 0; i < cfg.fields.length; i++) {
		        var key = cfg.fields[i];
		        if (!cfg.visible[key]) continue;
		        var val = props[key];
		        if (val === null || val === undefined || val === '') continue;
		        rows += '<tr><th style="min-width:80px; text-align:left;">' + key + '</th><td>' + fmt(val) + '</td></tr>';
		    }
		    
		    return '<table style="width:100%; border-collapse:collapse;">' + 
		           (rows || '<tr><td>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>') + 
		           '</table>';
		}

        function buildLabelContent_map_data(feature) {
            var cfg = labelFieldConfig_map_data;
            var props = feature && feature.properties ? feature.properties : feature;
            if (!props) return '';
            var parts = [];
            for (var i = 0; i < cfg.fields.length; i++) {
                var key = cfg.fields[i];
                if (!cfg.visible[key]) continue;
                var v = props[key];
                if (v === null || v === undefined || v === '') continue;
                parts.push(String(v));
            }
            if (!parts.length) return '';
            var multi = parts.length > 1;
            var cls = multi ? 'q2w-label q2w-label--multi' : 'q2w-label q2w-label--single';
            var sep = multi ? '\n' : ' ';
            return '<div class="' + cls + '" style="color:#ffffff; font-size:10pt; font-family:\'Open Sans\', sans-serif;">' +
                parts.join(sep) +
                '</div>';
        }
        
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
       function pop_map_data(feature, layer) {
		    layer.bindPopup(function(l) {
		        var content = buildPopupContent_map_data(l.feature);
		        
		        var latlng = l.getLatLng();
		        var address = l.feature.properties['ì£¼ì†Œ'] || l.feature.properties['ì†Œì¬ì§€(í†µ'] || l.feature.properties['ì†Œì¬ì§€'] || '';
		        content += '<div style="margin-top:8px; text-align:center;">' +
		            '<button onclick="openRoadview({lat:' + latlng.lat + ',lng:' + latlng.lng + '},\'' + address.replace(/'/g, '') + '\')" ' +
		            'style="padding:6px 16px; background:#0051af; color:white; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold;">' +
		            'ğŸ“· ì´ ìœ„ì¹˜ ë¡œë“œë·° ë³´ê¸°</button></div>';
		        return content;
		    }, {
		        maxHeight: 500,
		        minWidth: 400,
		        maxWidth: 450,
		        offset: [0, -10],
		        className: 'custom-popup-styled'
		    });
		
		    layer.on('popupopen', function(e) {
		        addClassToPopupIfMedia(e.popup.getContent(), e.popup);
		        var img = e.popup._container.querySelector('img');
		        if (img) {
		            img.onload = function() { e.popup.update(); };
		        }
		    });
		}
        function style_map_data_0() {
            return {
                pane: 'pane_map_data',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(133,182,111,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_map_data');
        map.getPane('pane_map_data').style.zIndex = 400;
        map.getPane('pane_map_data').style['mix-blend-mode'] = 'normal';
        var layer_map_data = new L.geoJson(json_map_data, {
            attribution: '',
            interactive: true,
            dataVar: 'json_map_data',
            layerName: 'layer_map_data',
            pane: 'pane_map_data',
            onEachFeature: pop_map_data,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_map_data_0(feature));
            },
        });
        bounds_group.addLayer(layer_map_data);
        map.addLayer(layer_map_data);
        
        var LabelToggleLayer = L.Layer.extend({
            onAdd: function(m) {
                m.getContainer().classList.remove('labels-hidden');
            },
            onRemove: function(m) {
                m.getContainer().classList.add('labels-hidden');
            }
        });
        var layer_labels_map_data = new LabelToggleLayer();
        layer_labels_map_data.addTo(map);

		// B ë°ì´í„° ë ˆì´ì–´
		var layer_B_data_0 = new L.geoJson(json_B_data_0, {
		    onEachFeature: function(feature, layer) {
		        if (typeof pop_map_data === 'function') {
		            pop_map_data(feature, layer);
		        }
		        
		        var labelContent = buildLabelContent_B_data(feature);
		
		        layer.bindTooltip(labelContent, {
		            permanent: true,
		            direction: 'top',
		            className: 'css_map_data_B',
		            offset: [0, -10]
		        });
		    },
		    pointToLayer: function (feature, latlng) {
		        return L.circleMarker(latlng, {
		            radius: 6,
		            fillColor: "#3388ff", 
		            color: "#000",
		            weight: 1,
		            fillOpacity: 0.8
		        });
		    }
		});

		// C ë°ì´í„° ë ˆì´ì–´ (ìƒˆë¡œ ì¶”ê°€)
		var layer_C_data_0 = new L.geoJson(json_C_data_0, {
		    onEachFeature: function(feature, layer) {
		        if (typeof pop_map_data === 'function') {
		            pop_map_data(feature, layer);
		        }
		        
		        var labelContent = buildLabelContent_C_data(feature);
		
		        layer.bindTooltip(labelContent, {
		            permanent: true,
		            direction: 'top',
		            className: 'css_map_data_C',
		            offset: [0, -10]
		        });
		    },
		    pointToLayer: function (feature, latlng) {
		        return L.circleMarker(latlng, {
		            radius: 6,
		            fillColor: "#ff6b35", // ì£¼í™©ìƒ‰ìœ¼ë¡œ êµ¬ë¶„
		            color: "#000",
		            weight: 1,
		            fillOpacity: 0.8
		        });
		    }
		});

        // --- í†µí•© ì»¨íŠ¸ë¡¤ ì„¤ì • ---
        var baseMaps = {};
        var overlays = {
            'A ë°ì´í„°(ë§ˆì»¤)': layer_map_data,
            'B ë°ì´í„°(ë§¤ë¬¼)': layer_B_data_0,
            'C ë°ì´í„°(ë¬¼ë¥˜)': layer_C_data_0, // ìƒˆë¡œ ì¶”ê°€!
            'í…ìŠ¤íŠ¸(ë¼ë²¨)': layer_labels_map_data
        };

        window.layerControl = L.control.layers(
            baseMaps, 
            overlays, 
            { collapsed: false, position: 'topright' }
        ).addTo(map);

		// ë¼ë²¨ í•„ë“œë³„ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ ì»¨íŠ¸ë¡¤ (ë™ì  ë²„ì „)
        (function addLabelFieldToggleControl() {
            var Control = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function(m) {
                    var div = L.DomUtil.create('div', 'popup-field-toggle');
                    div.id = 'dynamic-label-toggle';
                    div.innerHTML = [
                        '<div class="title" style="font-weight:bold; margin-bottom:5px;">ë¼ë²¨ í•„ë“œ í† ê¸€</div>',
                        '<div class="actions" style="margin-bottom:5px;">',
                        '  <button type="button" data-action="all" style="font-size:10px;">ì „ì²´</button>',
                        '  <button type="button" data-action="none" style="font-size:10px;">í•´ì œ</button>',
                        '</div>',
                        '<div class="list"></div>'
                    ].join('');

                    L.DomEvent.disableClickPropagation(div);
                    L.DomEvent.disableScrollPropagation(div);

                    div.updateUI = function() {
                        var list = div.querySelector('.list');
                        list.innerHTML = '';
                        
                        var cfg, targetLayer, buildFunc;
                        if (map.hasLayer(layer_C_data_0)) {
                            cfg = labelFieldConfig_C_data;
                            targetLayer = layer_C_data_0;
                            buildFunc = buildLabelContent_C_data;
                        } else if (map.hasLayer(layer_B_data_0)) {
                            cfg = labelFieldConfig_B_data;
                            targetLayer = layer_B_data_0;
                            buildFunc = buildLabelContent_B_data;
                        } else {
                            cfg = labelFieldConfig_map_data;
                            targetLayer = layer_map_data;
                            buildFunc = buildLabelContent_map_data;
                        }

						function refresh() {
						    targetLayer.eachLayer(function(lyr) {
						        lyr.unbindTooltip();
						        
						        var newContent = buildFunc(lyr.feature);
						        
						        if (newContent) {
						            var className = 'css_map_data';
						            if (targetLayer === layer_B_data_0) className = 'css_map_data_B';
						            if (targetLayer === layer_C_data_0) className = 'css_map_data_C';
						            
						            lyr.bindTooltip(newContent, {
						                permanent: true,
						                direction: 'top',
						                className: className,
						                offset: [0, -10],
						                sticky: false,
						                opacity: 1,
						                interactive: false
						            });
						        }
						    });
						
						    if (typeof resetLabels === 'function') {
						        resetLabels([targetLayer]); 
						    }
						}

                        cfg.fields.forEach(function(key, i) {
                            var row = document.createElement('label');
                            row.style.display = 'block';
                            var checked = cfg.visible[key] ? 'checked' : '';
                            row.innerHTML = '<input type="checkbox" ' + checked + '> <span style="font-size:11px;">' + key + '</span>';
                            
                            row.querySelector('input').addEventListener('change', function() {
                                cfg.visible[key] = !!this.checked;
                                refresh();
                            });
                            list.appendChild(row);
                        });

                        div.querySelector('[data-action="all"]').onclick = function() {
                            cfg.fields.forEach(function(k) { cfg.visible[k] = true; });
                            div.updateUI(); refresh();
                        };
                        div.querySelector('[data-action="none"]').onclick = function() {
                            cfg.fields.forEach(function(k) { cfg.visible[k] = false; });
                            div.updateUI(); refresh();
                        };
                    };

                    m.on('overlayadd overlayremove', function() {
                        div.updateUI();
                    });

                    setTimeout(function() { div.updateUI(); }, 100);
                    return div;
                }
            });
            map.addControl(new Control());
        })();
        
        setBounds();
        var i = 0;
        layer_map_data.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip(buildLabelContent_map_data(layer.feature), {permanent: true, offset: [-0, -16], className: 'css_map_data'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });

		// ë°ì´í„°ë³„ í•„í„° í•„ë“œ ì •ì˜
		var filterFieldConfig = {
		    A: [
		        { field: 'ì œì¶œì²˜',  placeholder: 'ì˜ˆ: ê¸°ì—…ì€í–‰' },
		        { field: 'ì£¼ì†Œ',    placeholder: 'ì˜ˆ: ì„œìš¸' },
		        { field: 'ë‹´ë‹¹ì',  placeholder: 'ë‹´ë‹¹ì ì´ë¦„' },
		        { field: 'ë¬¼ê±´ì¢…ë¥˜', placeholder: 'ì˜ˆ: ì•„íŒŒíŠ¸' },
		        { field: 'ìƒíƒœ',    placeholder: 'ì˜ˆ: ì™„ë£Œ' }
		    ],
		    B: [
		        { field: 'ì†Œì¬ì§€(í†µ', placeholder: 'ì˜ˆ: ì„œìš¸ ê°•ë‚¨' },
		        { field: 'êµ¬ë¶„',      placeholder: 'ì˜ˆ: ìƒê°€' },
		        { field: 'ì„¸ë¶€ìš©ë„',  placeholder: 'ì˜ˆ: ê·¼ë¦°ìƒê°€' },
		        { field: 'ë³´ì¦ê¸ˆ/ì›”', placeholder: 'ì˜ˆ: 1000/50' },
		        { field: 'ì˜ë¢°ê¸ˆì•¡(', placeholder: 'ê¸ˆì•¡ ì…ë ¥' }
		    ],
		    C: [
		        { field: 'ë¬¼ë¥˜ì„¼í„°ëª…', placeholder: 'ì˜ˆ: ì¿ íŒ¡' },
		        { field: 'ì†Œì¬ì§€',     placeholder: 'ì˜ˆ: ê²½ê¸° ì´ì²œ' },
		        { field: 'êµ¬ë¶„',       placeholder: 'ì˜ˆ: ë³µí•©' },
		        { field: 'ì£¼ìš” ì„ì°¨ì¸', placeholder: 'ì˜ˆ: ì¿ íŒ¡' },
		        { field: 'ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)', placeholder: 'ê¸ˆì•¡ ì…ë ¥' }
		    ]
		};
		
		var activeFilterType = 'A';
		
		function buildFilterInputs(type) {
		    var container = document.getElementById('dynamic-filter-inputs');
		    var badge = document.getElementById('filter-layer-badge');
		    if (!container) return;
		
		    if (type === 'C') {
		        badge.textContent = 'C ë°ì´í„°';
		        badge.style.background = '#ff6b35';
		    } else if (type === 'B') {
		        badge.textContent = 'B ë°ì´í„°';
		        badge.style.background = '#3182ce';
		    } else {
		        badge.textContent = 'A ë°ì´í„°';
		        badge.style.background = '#0051af';
		    }
		
		    container.innerHTML = '';
		    var fields = filterFieldConfig[type] || [];
		
		    fields.forEach(function(item) {
		        var wrapper = document.createElement('div');
		        wrapper.style.cssText = 'flex: 1 1 0; min-width: 80px;';
		        wrapper.innerHTML =
		            '<label style="font-size:10px; color:#888; display:block; margin-bottom:2px;">' + item.field + '</label>' +
		            '<input type="text"' +
		            '       class="multi-filter-input"' +
		            '       data-field="' + item.field + '"' +
		            '       placeholder="' + item.placeholder + '"' +
		            '       style="width:100%; padding:4px 7px; border:1px solid #ddd; border-radius:5px; box-sizing:border-box; font-size:11px;">';
		        container.appendChild(wrapper);
		        wrapper.querySelector('input').addEventListener('input', applyMultiFilter);
		    });
		
		    document.getElementById('filter-result-count').innerText = '';
		}
		
		function applyMultiFilter() {
		    var filterInputs = document.querySelectorAll('.multi-filter-input');
		    var activeFilters = [];
		
		    filterInputs.forEach(function(input) {
		        if (input.value.trim() !== '') {
		            activeFilters.push({
		                field: input.getAttribute('data-field'),
		                value: input.value.toLowerCase().trim()
		            });
		        }
		    });
		
		    var targetLayer;
		    if (activeFilterType === 'C') targetLayer = layer_C_data_0;
		    else if (activeFilterType === 'B') targetLayer = layer_B_data_0;
		    else targetLayer = layer_map_data;
		    
		    var visibleCount = 0;
		
		    targetLayer.eachLayer(function(layer) {
		        var props = layer.feature.properties;
		
		        var isMatch = activeFilters.every(function(filter) {
		            var dataValue = String(props[filter.field] || '').toLowerCase();
		            return dataValue.includes(filter.value);
		        });
		
		        if (isMatch) {
		            if (!map.hasLayer(layer)) map.addLayer(layer);
		            visibleCount++;
		        } else {
		            if (map.hasLayer(layer)) map.removeLayer(layer);
		        }
		    });
		
		    document.getElementById('filter-result-count').innerText = 'ê²€ìƒ‰ ê²°ê³¼: ' + visibleCount + 'ê±´';
		    updateDashboard();
		}
		
		map.on('overlayadd overlayremove', function(e) {
		    if (map.hasLayer(layer_C_data_0)) {
		        activeFilterType = 'C';
		    } else if (map.hasLayer(layer_B_data_0)) {
		        activeFilterType = 'B';
		    } else {
		        activeFilterType = 'A';
		    }
		    buildFilterInputs(activeFilterType);
		});
		
		buildFilterInputs('A');
		
		var roadviewObj = null;
		var roadviewClient = null;
		var roadviewOpen = false;
		
		function openRoadview(latlng, addressText) {
		    var panel = document.getElementById('roadview-panel');
		    panel.style.display = 'block';
		    roadviewOpen = true;
		
		    document.getElementById('map').style.bottom = '35%';
		    document.getElementById('kakao-map').style.bottom = '35%';
		    map.invalidateSize();
		
		    if (!roadviewObj) {
		        var container = document.getElementById('roadview');
		        roadviewObj = new kakao.maps.Roadview(container);
		        roadviewClient = new kakao.maps.RoadviewClient();
		    }
		
		    if (addressText) {
		        document.getElementById('roadview-address').innerText = 'â€” ' + addressText;
		    }
		
		    var kakaoLatLng = new kakao.maps.LatLng(latlng.lat, latlng.lng);
		    roadviewClient.getNearestPanoId(kakaoLatLng, 50, function(panoId) {
		        if (panoId) {
		            roadviewObj.setPanoId(panoId, kakaoLatLng);
		        } else {
		            document.getElementById('roadview-address').innerText = 'â€” í•´ë‹¹ ìœ„ì¹˜ì˜ ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.';
		        }
		    });
		}
		
		function closeRoadview() {
		    var panel = document.getElementById('roadview-panel');
		    panel.style.display = 'none';
		    roadviewOpen = false;
		
		    document.getElementById('map').style.bottom = '0';
		    document.getElementById('kakao-map').style.bottom = '0';
		    map.invalidateSize();
		}

			
		function exportToExcel() {
		    var isTypeC = (activeFilterType === 'C');
		    var isTypeB = (activeFilterType === 'B');
		    
		    var targetLayer, headers, fileName;
		    
		    if (isTypeC) {
		        targetLayer = layer_C_data_0;
		        headers = ['ë¬¼ë¥˜ì„¼í„°ëª…', 'ì†Œì¬ì§€', 'êµ¬ë¶„', 'ì—°ë©´ì (Py)', 'ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)', 'ì£¼ìš” ì„ì°¨ì¸'];
		        fileName = 'Cë¬¼ë¥˜_ê²€ìƒ‰ê²°ê³¼';
		    } else if (isTypeB) {
		        targetLayer = layer_B_data_0;
		        headers = ['ì†Œì¬ì§€(í†µ', 'êµ¬ë¶„', 'ì„¸ë¶€ìš©ë„', 'ë³´ì¦ê¸ˆ/ì›”', 'ì˜ë¢°ê¸ˆì•¡(', '(ë‹¨ìˆœ)ì˜ˆìƒ'];
		        fileName = 'Bë§¤ë¬¼_ê²€ìƒ‰ê²°ê³¼';
		    } else {
		        targetLayer = layer_map_data;
		        headers = ['ê°ì •ì„œë²ˆí˜¸', 'ë‹´ë‹¹ì', 'ì œì¶œì²˜', 'ì£¼ì†Œ', 'ë¬¼ê±´ì¢…ë¥˜', 'ìƒíƒœ'];
		        fileName = 'Aë°ì´í„°_ê²€ìƒ‰ê²°ê³¼';
		    }
		
		    var data = [];
		    data.push(headers.join(','));
		
		    targetLayer.eachLayer(function(layer) {
		        if (map.hasLayer(layer)) {
		            var props = layer.feature.properties;
		            var row = headers.map(function(header) {
		                var val = String(props[header] || "").replace(/,/g, " ");
		                return '"' + val + '"';
		            });
		            data.push(row.join(','));
		        }
		    });
		
		    if (data.length <= 1) {
		        alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }
		
		    var csvContent = "\uFEFF" + data.join("\n");
		    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
		    var url = URL.createObjectURL(blob);
		
		    var link = document.createElement("a");
		    link.setAttribute("href", url);
		    link.setAttribute("download", fileName + "_" + new Date().toLocaleDateString() + ".csv");
		    document.body.appendChild(link);
		    link.click();
		    document.body.removeChild(link);
		}
		
		document.querySelectorAll('.kakao-layer-toggle').forEach(function(checkbox) {
		    checkbox.addEventListener('change', function(e) {
		        var layerType = e.target.getAttribute('data-type');
		        var targetMap = window.kakaoMap || window.k_map || window.kakao_map;
		
		        if (targetMap && targetMap.addOverlayMapTypeId) {
		            if (e.target.checked) {
		                targetMap.addOverlayMapTypeId(kakao.maps.MapTypeId[layerType]);
		            } else {
		                targetMap.removeOverlayMapTypeId(kakao.maps.MapTypeId[layerType]);
		            }
		        } else {
		            console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		        }
		    });
		});
		
		var externalLabelConfig = { fields: [], visible: {} };
		var currentExternalLayer = null;
		var externalLayerGroup = L.featureGroup().addTo(map);
		
		document.getElementById('external-geojson-input').addEventListener('change', function(e) {
		    var file = e.target.files[0];
		    if (!file) return;
		
		    var reader = new FileReader();
		    reader.onload = function(event) {
		        try {
		            var geojsonData = JSON.parse(event.target.result);
		            
		            externalLayerGroup.clearLayers();
		            var oldUI = document.getElementById('external-label-controls');
		            if (oldUI) oldUI.remove();
		
		            var features = geojsonData.features || [];
		            if (features.length === 0) {
		                alert("íŒŒì¼ ë‚´ì— ìœ íš¨í•œ ë§¤ë¬¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		                return;
		            }
		
		            var sampleProps = features[0].properties;
		            externalLabelConfig.fields = Object.keys(sampleProps);
		            externalLabelConfig.fields.forEach(function(f) {
		                externalLabelConfig.visible[f] = (f.indexOf('ì†Œì¬ì§€') !== -1 || f === 'êµ¬ë¶„' || f === 'ì„¸ë¶€ìš©ë„');
		            });
		            
		            createExternalToggleUI(file.name);
		
		            currentExternalLayer = L.geoJson(geojsonData, {
		                onEachFeature: function(feature, layer) {
		                    if (typeof pop_map_data === 'function') pop_map_data(feature, layer);
		                    renderExternalLabel(layer);
		                },
		                pointToLayer: function (feature, latlng) {
		                    return L.circleMarker(latlng, {
		                        radius: 8,
		                        fillColor: "#ff4500",
		                        color: "#ffffff",
		                        weight: 2,
		                        fillOpacity: 0.9
		                    });
		                }
		            });
		
		            externalLayerGroup.addLayer(currentExternalLayer);
		            
		            var lControl = window.layerControl || window.controlLayers || window.control;
		            if (lControl) lControl.addOverlay(externalLayerGroup, "ğŸ“‚ " + file.name);
		
		            map.fitBounds(externalLayerGroup.getBounds());
		            alert("'" + file.name + "' ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
		
		        } catch (err) {
		            console.error("JSON íŒŒì‹± ì—ëŸ¬:", err);
		            alert("JSON í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		        }
		    };
		    reader.readAsText(file);
		});
		
		function renderExternalLabel(layer) {
		    var props = layer.feature.properties;
		    var labelParts = [];
		    
		    externalLabelConfig.fields.forEach(function(f) {
		        if (externalLabelConfig.visible[f] && props[f]) {
		            labelParts.push(String(props[f]));
		        }
		    });
		
		    if (labelParts.length > 0) {
		        var content = '<div style="text-align:center; font-weight:bold; line-height:1.4;">' + labelParts.join('<br>') + '</div>';
		        layer.bindTooltip(content, {
		            permanent: true,
		            offset: [0, -12],
		            direction: 'top',
		            className: 'css_map_data'
		        }).openTooltip();
		    } else {
		        layer.unbindTooltip();
		    }
		}
		
		function createExternalToggleUI(fileName) {
		    var parent = document.getElementById('external-geojson-input').parentNode;
		    var ui = document.createElement('div');
		    ui.id = 'external-label-controls';
		    ui.style = "margin-top:10px; padding:12px; background:#fff4e5; border-radius:10px; border:1px solid #ffb366; max-height:200px; overflow-y:auto; box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);";
		    
		    var title = '<div style="font-size:11px; font-weight:bold; color:#d35400; margin-bottom:8px; border-bottom:1px solid #ffcc99; padding-bottom:4px;">ğŸ“ ë¼ë²¨ í‘œì‹œ í•­ëª© ì„ íƒ (' + fileName + ')</div>';
		    
		    var listHtml = externalLabelConfig.fields.map(function(f) {
		        var isChecked = externalLabelConfig.visible[f] ? 'checked' : '';
		        return '<label style="display:block; font-size:11px; margin-bottom:4px; cursor:pointer; color:#5d4037;">' +
		               '<input type="checkbox" class="ext-chk" data-field="' + f + '" ' + isChecked + '> ' + f + '</label>';
		    }).join('');
		
		    ui.innerHTML = title + listHtml;
		    parent.appendChild(ui);
		
		    ui.querySelectorAll('.ext-chk').forEach(function(chk) {
		        chk.addEventListener('change', function() {
		            externalLabelConfig.visible[this.dataset.field] = this.checked;
		            if (currentExternalLayer) {
		                currentExternalLayer.eachLayer(function(lyr) { renderExternalLabel(lyr); });
		            }
		        });
		    });
		}


		function updateDashboard() {
		    var listContainer = document.getElementById('list-container');
		    var countElement = document.getElementById('list-count');
		    if (!map) return;
		
		    var bounds = map.getBounds();
		    var listHtml = '';
		    var count = 0;
		
		    map.eachLayer(function(layer) {
		        if ((layer instanceof L.CircleMarker || layer instanceof L.Marker) && layer.feature && bounds.contains(layer.getLatLng())) {
		            var p = layer.feature.properties;
		            count++;
		
		            var isTypeC = p.hasOwnProperty('ë¬¼ë¥˜ì„¼í„°ëª…');
		            var isTypeB = p.hasOwnProperty('ì†Œì¬ì§€(í†µ');
		
		            if (isTypeC) {
		                // Cë°ì´í„°(ë¬¼ë¥˜) ë””ìì¸
		                listHtml += `
		                    <div class="list-item type-c" onclick="focusAnyMarker(${layer._leaflet_id})" 
		                         style="padding:16px; border-bottom:1px solid #edf2f7; border-left:4px solid #ff6b35; background:#fff; cursor:pointer; margin-bottom:4px;">
		                        <div style="font-size:11px; color:#ff6b35; font-weight:bold; margin-bottom:4px;">ë¬¼ë¥˜ì„¼í„°</div>
		                        <div class="title" style="font-weight:bold; font-size:15px; color:#2d3748; line-height:1.4;">${p['ë¬¼ë¥˜ì„¼í„°ëª…'] || 'ì •ë³´ ì—†ìŒ'}</div>
		                        
		                        <div class="price" style="color:#e53e3e; font-weight:800; font-size:16px; margin-top:6px;">
		                            ${p['ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)'] ? p['ìƒì˜¨ ê³„ì•½ì›”ì„ëŒ€ë£Œ(ì›/Py)'] + 'ì›/Py' : 'ê¸ˆì•¡ ë¯¸ì •'}
		                        </div>
		
		                        <div class="info" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;">
		                            ${p['ì†Œì¬ì§€'] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">${p['ì†Œì¬ì§€']}</span>` : ''}
		                            ${p['êµ¬ë¶„'] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">${p['êµ¬ë¶„']}</span>` : ''}
		                            ${p['ì—°ë©´ì (Py)'] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">${p['ì—°ë©´ì (Py)']} Py</span>` : ''}
		                            ${p['ì£¼ìš” ì„ì°¨ì¸'] ? `<span style="background:#f8fafc; color:#64748b; padding:2px 6px; border-radius:4px; font-size:11px; border:1px dashed #cbd5e1;">ì„ì°¨: ${p['ì£¼ìš” ì„ì°¨ì¸']}</span>` : ''}
		                        </div>
		                    </div>
		                `;
		            } else if (isTypeB) {
		                // Bë°ì´í„°(ë§¤ë¬¼) ë””ìì¸
		                listHtml += `
		                    <div class="list-item type-b" onclick="focusAnyMarker(${layer._leaflet_id})" 
		                         style="padding:16px; border-bottom:1px solid #edf2f7; border-left:4px solid #3182ce; background:#fff; cursor:pointer; margin-bottom:4px;">
		                        <div style="font-size:11px; color:#3182ce; font-weight:bold; margin-bottom:4px;">ì‹¤ì‹œê°„ ë§¤ë¬¼</div>
		                        <div class="title" style="font-weight:bold; font-size:15px; color:#2d3748; line-height:1.4;">${p['ì†Œì¬ì§€(í†µ'] || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
		                        
		                        <div class="price" style="color:#e53e3e; font-weight:800; font-size:16px; margin-top:6px;">
		                            ${p['ì˜ë¢°ê¸ˆì•¡('] || 'ê¸ˆì•¡ ë¯¸ì •'}
		                        </div>
		
		                        <div class="info" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;">
		                            ${p['ì„¸ë¶€ìš©ë„'] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">${p['ì„¸ë¶€ìš©ë„']}</span>` : ''}
		                            ${p['ë³´ì¦ê¸ˆ/ì›”'] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">ë³´ì¦/ì›”: ${p['ë³´ì¦ê¸ˆ/ì›”']}</span>` : ''}
		                            ${p['ì˜ë¢°ê¸ˆì•¡('] ? `<span style="background:#f1f5f9; color:#475569; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #e2e8f0;">ì˜ë¢°: ${p['ì˜ë¢°ê¸ˆì•¡(']}</span>` : ''}
		                            ${p['(ë‹¨ìˆœ)ì˜ˆìƒ'] ? `<span style="background:#f8fafc; color:#64748b; padding:2px 6px; border-radius:4px; font-size:11px; border:1px dashed #cbd5e1;">ì˜ˆìƒ: ${p['(ë‹¨ìˆœ)ì˜ˆìƒ']}</span>` : ''}
		                        </div>
		                    </div>
		                `;
		            } else {
		                // Aë°ì´í„°(ê¸°ë³¸) ë””ìì¸
		                listHtml += `
		                    <div class="list-item type-a" onclick="focusAnyMarker(${layer._leaflet_id})" 
		                         style="padding:16px; border-bottom:1px solid #edf2f7; border-left:4px solid #718096; background:#f7fafc; cursor:pointer; margin-bottom:4px;">
		                        <div style="font-size:11px; color:#718096; font-weight:bold; margin-bottom:4px;">ê¸°ë³¸ ë°ì´í„°</div>
		                        <div class="title" style="font-weight:bold; font-size:14px; color:#4a5568;">${p['ì£¼ì†Œ'] || p['ê±´ëª…'] || 'ì •ë³´ ì—†ìŒ'}</div>
		                        <div class="info" style="font-size:12px; color:#718096; margin-top:6px;">
		                            ${p['ë¬¼ê±´ì¢…ë¥˜'] || ''} | ${p['ë‹´ë‹¹ì'] ? 'ë‹´ë‹¹: ' + p['ë‹´ë‹¹ì'] : 'ë‹´ë‹¹ì ë¯¸ì •'}
		                        </div>
		                    </div>
		                `;
		            }
		        }
		    });
		
		    listContainer.innerHTML = listHtml || '<div style="padding:40px; color:#a0aec0; text-align:center;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
		    countElement.innerText = count;
		}
		
		window.focusAnyMarker = function(leaflet_id) {
		    map.eachLayer(function(layer) {
		        if (layer._leaflet_id === leaflet_id) {
		            map.setView(layer.getLatLng(), 18);
		            layer.openPopup();
		        }
		    });
		};
		
		map.on('overlayadd overlayremove moveend zoomend', updateDashboard);

		var lControl = window.layerControl || window.controlLayers || window.control;
        </script>        
    </body>
</html>
